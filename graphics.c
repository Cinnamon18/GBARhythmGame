#include "graphics.h"
#include "audio.h"
#include "images/RhythmBackground.h"
#include "images/VictoryScreen.h"
#include "images/NoteImage.h"
#include "images/Note2Image.h"
#include "images/Note3Image.h"
#include "images/Note4Image.h"
#include "images/HitIndicator.h"
#include<stdio.h> 

// TA-TODO: Include any header files for images generated by nin10kit.
// Example for the provided garbage image:
//#include "images/garbage.h"

// TA-TODO: Add any draw/undraw functions for sub-elements of your app here.
// For example, for a snake game, you could have a drawSnake function
// or a drawFood function
//
// e.g.:
// static void drawSnake(Snake* snake);
// static void drawFood(Food* food);


// This function will be used to draw things that might have moved in a frame.
// For example, in a Snake game, draw the snake, the food, the score.


//TODO replace black w background
void drawFallingCircles(int noteIndex, int beatPercentElapsed) {
	int notesY = HIT_Y * beatPercentElapsed;
	int noteBaseOffset = (NOTE_PADDING / 2) + (noteIndex * (NOTE_SIZE + NOTE_PADDING));

	drawRectDMA(noteBaseOffset, notesY - BACKGROUND_REDRAW_HEIGHT, NOTE_SIZE, BACKGROUND_REDRAW_HEIGHT, BLACK);
	drawImageDMA(noteBaseOffset, notesY, NOTE_SIZE, NOTE_SIZE, Note4Image);
}

void drawTapIndicator(int noteIndex, int y) {
	drawImageDMA((NOTE_PADDING / 2) + (noteIndex * (NOTE_SIZE + NOTE_PADDING)), y, NOTE_SIZE, NOTE_SIZE, HitIndicator);
}

void clearTapIndicator(int noteIndex) {
	drawRectDMA((NOTE_PADDING / 2) + (noteIndex * (NOTE_SIZE + NOTE_PADDING)), HIT_Y_ACTUAL, NOTE_SIZE, NOTE_SIZE, BLACK);
}

//for drawing text & stuff
static char shortLivedCharBuffer[20]; 


void drawAppState(AppState *state) {
	AppState appState = *state;

	Song currentSong = songs[appState.currentSongIndex];

	switch(appState.nextState) {
		case SONG_SELECT:
		;

		//Draw the song selection carousell
		const u16 *img1, *img2, *img3;

		img2 = songs[appState.currentSongIndex].bigPreviewImage;

		if(appState.currentSongIndex == 0) {
			img1 = songs[NUM_SONGS - 1].smallPreviewImage;
			img3 = songs[1].smallPreviewImage;
		} else if (appState.currentSongIndex == (NUM_SONGS - 1)) {
			img1 = songs[NUM_SONGS - 2].smallPreviewImage;
			img3 = songs[0].smallPreviewImage;
		} else {
			img1 = songs[appState.currentSongIndex - 1].smallPreviewImage;
			img3 = songs[appState.currentSongIndex + 1].smallPreviewImage;
		}

		drawImageDMA(15, 55, 50, 50, img1);
		drawImageDMA(80, 42, 80, 80, img2);
		drawImageDMA(175, 55, 50, 50, img3);


		break;

		case SONG_PLAY_PREP:
		drawFullScreenImageDMA(RhythmBackground);
		break;


		case SONG_PLAY:
		;

        //Keep track of how far in the song we are
		int frameProgress = (vBlankCounter - appState.firstFrameOfThisSong);
		int beatProgress = (frameProgress / currentSong.framesPerBeat);
		int framesIntoThisBeat = frameProgress % currentSong.framesPerBeat;
		//int hack... it's hitymult x the actual percent
		int beatPercentElapsed = (framesIntoThisBeat * HIT_Y_MULT) / currentSong.framesPerBeat;

		//This is just to have the whole "brief pause after the song". may need to adjust if we want to have background effects going in that time.
		if (beatProgress > currentSong.beatCount) {
			break;
		}


		// DEBUG
		drawRectDMA(0, 0, 140, 20, BLACK);
		char str[25];
		sprintf(str, "debug: %d", (appState.tapCountdown)[3]);
		drawString(0, 0, str, WHITE);


		//Draw in the notes
		int i = 0;
		for(; i < NOTES_COUNT; i++) {
			Note note = notes[i];
			if(currentSong.beatmap[beatProgress] & note.mapCode) {
				drawFallingCircles(note.index, beatPercentElapsed);
			}

			//clear out a lingering note at the hit circle
			//TODO replace black with background
			if((currentSong.beatmap[beatProgress - 1] & note.mapCode) && (framesIntoThisBeat == 0)) {
				drawRectDMA((NOTE_PADDING / 2) + (note.index * (NOTE_SIZE + NOTE_PADDING)), HIT_Y_ACTUAL - 10, NOTE_SIZE, NOTE_SIZE + 10, BLACK);
			}

			//Draw hit indicators
			if((appState.tapCountdown)[note.index] > 0) {
				drawTapIndicator(note.index, HIT_Y_ACTUAL);
			} else if((appState.tapCountdown)[note.index] == 0) {
				clearTapIndicator(note.index);
			}
		}


		break;


		case SONG_COMPLETE:
		drawFullScreenImageDMA(VictoryScreen);

		//Tell the player how they did!

		drawImageDMA(20, 40, 80, 80, currentSong.bigPreviewImage);
		drawCenteredString(60, 135, 0, 0, currentSong.name, WHITE);

		sprintf(shortLivedCharBuffer, "Perfects: %d", appState.score.perfects);
		drawString(140, 45, shortLivedCharBuffer, WHITE);

		sprintf(shortLivedCharBuffer, "Greats: %d", appState.score.greats);
		drawString(140, 65, shortLivedCharBuffer, WHITE);

		sprintf(shortLivedCharBuffer, "Okays: %d", appState.score.oks);
		drawString(140, 85, shortLivedCharBuffer, WHITE);

		sprintf(shortLivedCharBuffer, "Misses: %d", appState.score.misses);
		drawString(140, 105, shortLivedCharBuffer, WHITE);

		sprintf(shortLivedCharBuffer, "Total Score: %d", appState.score.totalScore);
		drawString(110, 140, shortLivedCharBuffer, WHITE);

		break;

		case SONG_COMPLETE_NODRAW:
		break;

		default:
		break;
	}
}
